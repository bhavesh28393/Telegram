import logging
import random
import os
import asyncio
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    ContextTypes,
    filters,
)

# ================== CONFIG ==================
BOT_TOKEN = os.getenv("BOT_TOKEN")  # set in Render env
PORT = int(os.environ.get("PORT", 10000))
WEBHOOK_PATH = "/webhook"
WEBHOOK_URL = os.getenv("RENDER_EXTERNAL_URL") + WEBHOOK_PATH

# ================== LOGGING ==================
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ================== METHODS ==================
METHODS = [
    "h8", "vio1", "vio2", "vio3", "vio4", "vio5", "vio6", "vio7",
    "spm", "scm",
    "bully1", "bully2", "bully3",
    "sell_illigal1", "sell_illigal2", "sell_illigal3",
    "nud31", "nud32", "nud33", "nud34",
    "false_info",
    "imp_take_screenshot_of_pfp_and_search_in_google_lens"
]

# ================== HELPERS ==================
def generate_method():
    count_methods = random.randint(3, 5)
    selected = []
    for _ in range(count_methods):
        method = random.choice(METHODS)
        count = random.randint(1, 10)
        selected.append(f"{count}x{method}")
    return ", ".join(selected)

def get_username(link):
    try:
        link = link.strip().lower()
        if "instagram.com/" in link:
            username = link.split("instagram.com/")[1].split("/")[0].split("?")[0]
            return username if username else None
        return None
    except Exception:
        return None

# ================== HANDLERS ==================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("ğŸ“¢ Join Telegram", url="https://t.me/team_scorp1on")],
        [InlineKeyboardButton("ğŸ¥ Join YouTube", url="https://youtube.com/@team_scorpion12")],
        [InlineKeyboardButton("âœ… I've Joined Both", callback_data="welcome")]
    ]
    await update.message.reply_text(
        "Join our channels first ğŸ‘‡",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if query.data == "welcome":
        keyboard = [[InlineKeyboardButton("ğŸš€ Start Method Bot", callback_data="get_method")]]
        await query.edit_message_text(
            "ğ“†°ğ—ªğ—˜ğ—Ÿğ—–ğ—¢ğ— ğ—˜ ğ—§ğ—¢ ğ—¦ğ—–ğ—¢ğ—¥ğ—£ğ—œğ—¢ğ—¡ ğ— ğ—˜ğ—§ğ—›ğ—¢ğ—— ğ—•ğ—¢ğ—§ğ“†ª\n\nSend Instagram profile link.",
            reply_markup=InlineKeyboardMarkup(keyboard),
        )

    elif query.data == "get_method":
        context.user_data["waiting"] = True
        await query.edit_message_text(
            "ğŸ“ Send Instagram profile LINK:\n\nhttps://www.instagram.com/username/"
        )

    elif query.data == "another":
        context.user_data["waiting"] = True
        await query.edit_message_text(
            "ğŸ“ Send another Instagram profile LINK:"
        )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.user_data.get("waiting"):
        await start(update, context)
        return

    text = update.message.text

    if "instagram.com" not in text:
        await update.message.reply_text("âŒ Invalid Instagram link.")
        return

    username = get_username(text)
    if not username:
        await update.message.reply_text("âŒ Invalid Instagram profile.")
        return

    # ğŸ”„ LOADING MESSAGE
    loading = await update.message.reply_text(
        "â³ Loading meth...\nPlease wait ğŸ”„"
    )

    await asyncio.sleep(2)  # fake loading delay

    method = generate_method()

    # âœï¸ EDIT LOADING MESSAGE â†’ RESULT
    await loading.edit_text(
        f"""
âœ… REPORTING METHOD GENERATED

ğŸ¯ TARGET: @{username}
ğŸ§ª METHOD: {method}
ğŸ’ª STRENGTH: STRONG

ğŸ“Œ Instructions:
1. Use this meth: {method}
2. Do once per day
3. Mass report for better result

Provided by ğ“†°ğ“ğ™´ğ€ğ™¼ â€¢ ğš‚ğ‚ğ™¾ğ‘ğ™¿ğˆğ™¾ğğš‚ğ“†©ğŸ€
"""
    )

    context.user_data["waiting"] = False

    keyboard = [[InlineKeyboardButton("ğŸ”„ Another Method", callback_data="another")]]
    await update.message.reply_text(
        "Generate another method?",
        reply_markup=InlineKeyboardMarkup(keyboard),
    )

async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE):
    logger.error("Error:", exc_info=context.error)

# ================== MAIN ==================
def main():
    app = Application.builder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(button_handler))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.add_error_handler(error_handler)

    app.run_webhook(
        listen="0.0.0.0",
        port=PORT,
        webhook_url=WEBHOOK_URL,
        url_path=WEBHOOK_PATH,
    )

if __name__ == "__main__":
    main()
    
